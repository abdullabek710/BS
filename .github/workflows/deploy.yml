name: Deploy Odoo Modules

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y sshpass rsync

      - name: Deploy modules to Odoo server
        env:
          SSHPASS: ${{ secrets.SERVER_PASS }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_IP }}
        run: |
          set -e
          
          REMOTE_ADDONS_PATH="~/dockerodoo/odoo/custom-addons"
          
          echo "ðŸš€ Starting deployment..."
          echo ""
          
          # Find all app folders (contains __manifest__.py)
          APPS=$(find . -maxdepth 1 -type d -name "*" ! -name "." -exec test -f {}/__manifest__.py \; -print)
          
          if [ -z "$APPS" ]; then
            echo "âŒ No apps found with __manifest__.py"
            exit 1
          fi
          
          echo "ðŸ“¦ Found apps:"
          echo "$APPS" | sed 's|./||g' | sed 's|^|   â€¢ |'
          echo ""
          
          # Verify remote directory exists
          echo "â†’ Verifying remote addons directory..."
          sshpass -p "$SSHPASS" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "
            mkdir -p $REMOTE_ADDONS_PATH
          " || exit 1
          
          # Upload all apps
          echo "â†’ Uploading modules..."
          for APP in $APPS; do
            APP_NAME=$(basename "$APP")
            echo "  âœ“ Uploading $APP_NAME..."
            sshpass -p "$SSHPASS" rsync -avz --delete \
              "$APP/" "$SERVER_USER@$SERVER_HOST:$REMOTE_ADDONS_PATH/$APP_NAME/" \
              --exclude='__pycache__' \
              --exclude='*.pyc' \
              --exclude='.git' \
              --exclude='.gitignore' > /dev/null 2>&1 || exit 1
          done
          echo "âœ… All modules uploaded"
          echo ""
          
          # Restart Odoo
          echo "â†’ Restarting Odoo services..."
          sshpass -p "$SSHPASS" ssh -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST "
            cd ~/dockerodoo
            docker-compose down
            docker-compose up -d
            sleep 3
          " || exit 1
          
          echo ""
          echo "âœ… Deployment complete!"
          echo "ðŸŽ‰ All modules are now live"